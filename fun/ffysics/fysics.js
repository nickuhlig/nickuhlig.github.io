(function(){

const debugMode     = document.location.search.indexOf('debug') != -1
const wireframeMode = document.location.search.indexOf('wireframe') != -1

const viewportSize = {
  width: document.documentElement.clientWidth, 
  height: document.documentElement.clientHeight,
}

// shapes computed from SVG using shapesFromSVGPaths
const shapeData = {
  1: [
    { color: '#1ABCFE', 
      origin: {x:-3, y:-35},
      vertices: [
        {x:-24.000095757510785,y:11.999609627398957},
        {x:-23.87714980062497,y:9.002976644000519},
        {x:-23.506851914193753,y:6.026794660052765},
        {x:-22.889533373382214,y:3.0918972372622378},
        {x:-22.0283588495518,y:0.21908115144680806},
        {x:-20.92928293612254,y:-2.571387541332733},
        {x:-19.600548776652936,y:-5.260106813946258},
        {x:-18.05211451914561,y:-7.82859302763034},
        {x:-16.295582684543255,y:-10.259518396893036},
        {x:-14.343647631671553,y:-12.53652931455661},
        {x:-12.209995421435957,y:-14.644217741528045},
        {x:-9.909212979343062,y:-16.568077576199066},
        {x:-7.4568757143284135,y:-18.294587266483795},
        {x:-4.869493874576216,y:-19.811223399677765},
        {x:-2.1645340051914523,y:-21.10656727556277},
        {x:0.6393686208461453,y:-22.17092092041064},
        {x:3.5226646337245633,y:-22.996331942120083},
        {x:6.464992133114212,y:-23.577235025206097},
        {x:9.44551428887593,y:-23.91087006483365},
        {x:11.999604242489212,y:-24.00009037260104},
        {x:12.443422881100052,y:-23.997383003906794},
        {x:15.438330260250442,y:-23.837965846845396},
        {x:18.409725752804153,y:-23.43104614023257},
        {x:21.336738196346634,y:-22.77738232616473},
        {x:24.198630896541946,y:-21.88058377508212},
        {x:26.975253668758743,y:-20.74697531465579},
        {x:29.647328940365192,y:-19.385076177158844},
        {x:32.19655760857808,y:-17.805130970516693},
        {x:34.60573348138082,y:-16.018889200726043},
        {x:36.858668890926715,y:-14.039205801525604},
        {x:38.940103140804645,y:-11.879927408733856},
        {x:40.835645285580036,y:-9.555753958263885},
        {x:42.53191145989644,y:-7.082392466106903},
        {x:44.01653632256734,y:-4.476516974010956},
        {x:45.27834471795308,y:-1.7557485223202818},
        {x:46.307866660091754,y:1.0611317038149721},
        {x:47.09744605157125,y:3.954447019061554},
        {x:47.64192732903707,y:6.903721082171906},
        {x:47.93895873162496,y:9.888108479938019},
        {x:47.999904242489215,y:11.999909627398957},
        {x:47.98914679620015,y:12.886855351886261},
        {x:47.793252554867145,y:15.879596936664093},
        {x:47.34976538750875,y:18.845745313128937},
        {x:46.659864035580036,y:21.76443504091214},
        {x:45.7276225957607,y:24.6149837851138},
        {x:44.55969008538472,y:27.377341496905792},
        {x:43.1648841771816,y:30.03238223787259},
        {x:41.553681937191364,y:32.56197284456204},
        {x:39.73799666497457,y:34.94904445405911},
        {x:37.730874625179645,y:37.17755244966458},
        {x:35.54625472161519,y:39.23237918611478},
        {x:33.19903716180074,y:41.099293935260285},
        {x:30.704997626278278,y:42.764998662433136},
        {x:28.080998984310504,y:44.21736263032865},
        {x:25.34481391045796,y:45.44538234468412},
        {x:22.51536234948384,y:46.43983958955717},
        {x:19.61248263451802,y:47.19345592256498},
        {x:16.656696883175247,y:47.701447713336464},
        {x:13.66887911889302,y:47.96186374422025},
        {x:11.999904242489212,y:47.999909627398964},
        {x:10.669748869869583,y:47.97575114961576},
        {x:7.679633704159134,y:47.74328731294584},
        {x:4.719178763363235,y:47.26321910615873},
        {x:1.8092752370570828,y:46.53715442415189},
        {x:-1.0294560518528293,y:45.56956218477201},
        {x:-3.7771252718235324,y:44.36747478242826},
        {x:-6.414713772800093,y:42.93992732759427},
        {x:-8.924284371402388,y:41.2977344870181},
        {x:-11.288879784610396,y:39.452883946856964},
        {x:-13.492637070682173,y:37.418576466998566},
        {x:-15.520545157458907,y:35.20896266694974},
        {x:-17.358552130725506,y:32.83904575105618},
        {x:-18.99345508482707,y:30.324715840777863},
        {x:-20.41330781843913,y:27.68298457857083},
        {x:-21.607370587852124,y:24.931819188556183},
        {x:-22.566662016179684,y:22.090265500506867},
        {x:-23.28422646489394,y:19.178264844378937},
        {x:-23.75570521023524,y:16.21641372438382},
        {x:-23.979564999550853,y:13.225631940326203},
      ]
    },
    { color: '#0ACF83', 
      origin: {x:-73.5, y:36},
      vertices: [
        {x:-25.195596303268402,y:13.195551837772673},
        {x:-25.0726503799102,y:10.198919261783903},
        {x:-24.70235344342801,y:7.222737277836149},
        {x:-24.085036064907044,y:4.287839855045622},
        {x:-23.22386654786679,y:1.4150237692301921},
        {x:-22.12479385308835,y:-1.375452076106722},
        {x:-20.7960636275253,y:-4.064177070766146},
        {x:-19.24763580731961,y:-6.632670437007599},
        {x:-17.491115416809052,y:-9.063602958827667},
        {x:-15.539192523284882,y:-11.340623174815827},
        {x:-13.405553187652558,y:-13.448323761134796},
        {x:-11.104783620162934,y:-15.372200046687775},
        {x:-8.652462090774506,y:-17.098727975993803},
        {x:-6.065085973068207,y:-18.61539450755661},
        {x:-3.360143269821137,y:-19.910763059764555},
        {x:-0.5562549488982853,y:-20.975142632632902},
        {x:2.327032480911285,y:-21.80058718195503},
        {x:5.269354258255035,y:-22.38152540197914},
        {x:8.249873552993805,y:-22.71519637203162},
        {x:10.804403696731598,y:-22.804448162227324},
        {x:46.8044036967316,y:-22.804448162227324},
        {x:46.8044036967316,y:13.195551837772673},
        {x:46.80169716902164,y:13.638930286259},
        {x:46.64231530256656,y:16.63384052643234},
        {x:46.235432062820465,y:19.6052446020549},
        {x:45.58179131575015,y:22.53225704559738},
        {x:44.68502656050113,y:25.39416405090744},
        {x:43.551432047561676,y:28.170792545170137},
        {x:42.18955651350406,y:30.842884982914278},
        {x:40.609625254348785,y:33.39211937317307},
        {x:38.82338563032535,y:35.8013009680217},
        {x:36.84372368879703,y:38.0542363775676},
        {x:34.684446726516754,y:40.13566490539963},
        {x:32.360283289627105,y:42.03120705017502},
        {x:29.886923227981598,y:43.72746750244553},
        {x:27.281046305374176,y:45.21212097534592},
        {x:24.560287867263824,y:46.47392937073166},
        {x:21.743399058059723,y:47.50345131287033},
        {x:18.850095186904937,y:48.29304787048752},
        {x:15.900829706863433,y:48.83754059204514},
        {x:12.916428003982574,y:49.13459488281662},
        {x:10.804403696731598,y:49.195551837772676},
        {x:9.917683993057281,y:49.18480011352951},
        {x:6.924945269302398,y:48.9889230383342},
        {x:3.9587997538605038,y:48.545458759159395},
        {x:1.0400871378937069,y:47.85558029541428},
        {x:-1.8104573147735294,y:46.923361743778536},
        {x:-4.572816457076996,y:45.75545212158615},
        {x:-7.227865781112641,y:44.36066910156662},
        {x:-9.757474984451264,y:42.74948402771408},
        {x:-12.144559468551606,y:40.93381019958908},
        {x:-14.373083915039032,y:38.92669388184006},
        {x:-16.427922810836762,y:36.7420968664592},
        {x:-18.29484828881833,y:34.394885028690645},
        {x:-19.960571255012482,y:31.90086265930588},
        {x:-21.412944163604706,y:29.276869739384004},
        {x:-22.640984083934754,y:26.54069610962326},
        {x:-23.635460104270905,y:23.71127315887863},
        {x:-24.389091368242234,y:20.80838772186691},
        {x:-24.89709679357621,y:17.852604831547087},
        {x:-25.157538892178863,y:14.864778484196012},
      ]
    },
    { color: '#FF7262', 
      origin: {x:-6, y:-108},
      vertices: [
        {x:-21.75297187257832,y:-23.99988813286972},
        {x:-21.75297187257832,y:48.00011186713028},
        {x:14.247028127421675,y:48.00011186713028},
        {x:17.243663564433394,y:47.87716798895645},
        {x:20.219848409404097,y:47.50686006659317},
        {x:23.154737249125777,y:46.88953714484024},
        {x:26.027553334941206,y:46.028369237125396},
        {x:28.818017736186327,y:44.92928438299942},
        {x:31.506744161357226,y:43.60055666083145},
        {x:34.075244680156054,y:42.052125264347076},
        {x:36.50616432737285,y:40.295594502628326},
        {x:38.78318955015117,y:38.34368448370743},
        {x:40.89089371274883,y:36.210036565006256},
        {x:42.81475998472148,y:33.90926485174942},
        {x:44.541295781840624,y:31.456944752872467},
        {x:46.057958379496874,y:28.869567204654693},
        {x:47.35332657407695,y:26.164624501407626},
        {x:48.4177186639207,y:23.360741902530673},
        {x:49.2431638390916,y:20.477445889652255},
        {x:49.824105993022265,y:17.535135556400302},
        {x:50.15778137754375,y:14.554621983707431},
        {x:50.24702812742168,y:12.000111867130283},
        {x:50.24432159971172,y:11.556707669437412},
        {x:50.08493973325664,y:8.561800290287021},
        {x:49.678056493510546,y:5.590401936710361},
        {x:49.02441574644023,y:2.663383771121982},
        {x:48.12764526914531,y:-0.19853038674544976},
        {x:46.99405647825176,y:-2.975156019985196},
        {x:45.63218666624004,y:-5.647237013637541},
        {x:44.05226112913066,y:-8.196472834407805},
        {x:42.26601578306133,y:-10.605657290279387},
        {x:40.28634811948711,y:-12.858595560848235},
        {x:38.12706543516094,y:-14.94002838021469},
        {x:35.80290772031719,y:-16.835562657176972},
        {x:33.32953621457988,y:-18.531832050144196},
        {x:30.723670736064257,y:-20.016466568767548},
        {x:28.002918019999804,y:-21.27827871924591},
        {x:25.186046376933394,y:-22.307790111362458},
        {x:22.29274250577861,y:-23.097383271514893},
        {x:19.343465581645308,y:-23.641880396365643},
        {x:16.359052434672652,y:-23.938928920387745},
        {x:14.247028127421675,y:-23.99988813286972},
      ]
    },
    { color: '#F24E1E', 
      origin: {x:-72, y:-108},
      vertices: [
        {x:-26.247031114562567,y:11.999976322236709},
        {x:-26.12408426360708,y:14.996608898225478},
        {x:-25.753785527809676,y:17.972790882173232},
        {x:-25.136466584666785,y:20.90768830496376},
        {x:-24.275294385417517,y:23.78050152975624},
        {x:-23.176220796569403,y:26.570971653047256},
        {x:-21.847487352355536,y:29.25969235617226},
        {x:-20.29906167791706,y:31.82818143087929},
        {x:-18.542540214522894,y:34.259112522187884},
        {x:-16.590617320998724,y:36.536137744966204},
        {x:-14.456977270110665,y:38.64384190756386},
        {x:-12.156211278899727,y:40.567713901582415},
        {x:-9.703885457976876,y:42.294249698701556},
        {x:-7.116512201293526,y:43.810912296357806},
        {x:-4.411560914977608,y:45.106280490937884},
        {x:-1.6076783161006567,y:46.170666858735736},
        {x:1.2756119747318628,y:46.996112033906634},
        {x:4.217930891052664,y:47.5770541878373},
        {x:7.198455907837332,y:47.91072957235878},
        {x:9.75296888543743,y:47.99997632223671},
        {x:45.75296888543743,y:47.99997632223671},
        {x:45.75296888543743,y:-24.000023677763288},
        {x:9.75296888543743,y:-24.000023677763288},
        {x:9.309576131836355,y:-23.997321064227485},
        {x:6.3146573085941675,y:-23.837938569304292},
        {x:3.3432589550175074,y:-23.431053876694982},
        {x:0.41624078942912845,y:-22.777424081978147},
        {x:-2.4456719379268286,y:-21.880652442392652},
        {x:-5.22230901525837,y:-20.747065260824506},
        {x:-7.894391439422188,y:-19.385190442022626},
        {x:-10.443625829680977,y:-17.805263116773908},
        {x:-12.852818868621407,y:-16.01901848596031},
        {x:-15.10575570867878,y:-14.039345100340194},
        {x:-17.187174938186224,y:-11.880085304197616},
        {x:-19.082719943984564,y:-9.555917575773544},
        {x:-20.778987191184576,y:-7.082548931059188},
        {x:-22.263622067435797,y:-4.476674869474715},
        {x:-23.525423310264166,y:-1.7559250144332132},
        {x:-24.554940066798743,y:1.0609580727249899},
        {x:-25.344531438811835,y:3.9542676659256735},
        {x:-25.889026574357565,y:6.903550312104873},
        {x:-26.18607190208059,y:9.887946292939834},
      ]
    },
    { color: '#A259FF', 
      origin: {x:-72, y:-35},
      vertices: [
        {x:-26.247031114562567,y:11.999976322236709},
        {x:-26.12408426360708,y:14.996608898225478},
        {x:-25.753785527809676,y:17.972790882173232},
        {x:-25.136466584666785,y:20.90768830496376},
        {x:-24.275294385417517,y:23.78050152975624},
        {x:-23.176220796569403,y:26.570971653047256},
        {x:-21.847487352355536,y:29.25969235617226},
        {x:-20.29906167791706,y:31.82818143087929},
        {x:-18.542540214522894,y:34.259112522187884},
        {x:-16.590617320998724,y:36.536137744966204},
        {x:-14.456977270110665,y:38.64384190756386},
        {x:-12.156211278899727,y:40.567713901582415},
        {x:-9.703885457976876,y:42.294249698701556},
        {x:-7.116512201293526,y:43.810912296357806},
        {x:-4.411560914977608,y:45.106280490937884},
        {x:-1.6076783161006567,y:46.170666858735736},
        {x:1.2756119747318628,y:46.996112033906634},
        {x:4.217930891052664,y:47.5770541878373},
        {x:7.198455907837332,y:47.91072957235878},
        {x:9.75296888543743,y:47.99997632223671},
        {x:45.75296888543743,y:47.99997632223671},
        {x:45.75296888543743,y:-24.000023677763288},
        {x:9.75296888543743,y:-24.00002367776328},
        {x:9.309576131836355,y:-23.997321064227485},
        {x:6.3146573085941675,y:-23.837938569304292},
        {x:3.3432589550175074,y:-23.431053876694982},
        {x:0.41624078942912845,y:-22.777424081978147},
        {x:-2.4456719379268286,y:-21.880652442392652},
        {x:-5.22230901525837,y:-20.747065260824506},
        {x:-7.894391439422188,y:-19.385190442022626},
        {x:-10.443625829680977,y:-17.805263116773908},
        {x:-12.852818868621407,y:-16.01901848596031},
        {x:-15.10575570867878,y:-14.039345100340194},
        {x:-17.187174938186224,y:-11.880085304197616},
        {x:-19.082719943984564,y:-9.555917575773544},
        {x:-20.778987191184576,y:-7.082548931059188},
        {x:-22.263622067435797,y:-4.476674869474715},
        {x:-23.525423310264166,y:-1.7559250144332132},
        {x:-24.554940066798743,y:1.0609580727249899},
        {x:-25.344531438811835,y:3.9542676659256735},
        {x:-25.889026574357565,y:6.903550312104873},
        {x:-26.18607190208059,y:9.887946292939834},
      ]
    },
  ],
  2: [
    { color: '#1ABCFE', 
      origin: {x:-3, y:-35},
      vertices: [
        {x:-24.000032521309457,y:12.000104678477733},
        {x:-23.506788677992425,y:6.027289711131541},
        {x:-22.028295613350473,y:0.21957620252558385},
        {x:-19.600485540451608,y:-5.259611762867484},
        {x:-16.295519448341928,y:-10.259023345814262},
        {x:-12.209932185234626,y:-14.643722690449271},
        {x:-7.456812478127082,y:-18.294092215405023},
        {x:-2.1644707689901175,y:-21.106072224484002},
        {x:3.522727869925898,y:-22.995836891041314},
        {x:9.445577525077265,y:-23.91037501375488},
        {x:11.999667478690547,y:-23.99959532152227},
        {x:15.438393496451777,y:-23.837470795766627},
        {x:21.33680143254797,y:-22.77688727508596},
        {x:26.975316904960078,y:-20.74648026357702},
        {x:32.19662084477941,y:-17.80463591943792},
        {x:36.85873212712804,y:-14.03871075044683},
        {x:40.83570852178136,y:-9.555258907185111},
        {x:44.01659955876867,y:-4.476021922932182},
        {x:46.30792989629308,y:1.061626754893748},
        {x:47.641990565238395,y:6.9042161332506815},
        {x:47.99996747869054,y:12.000404678477732},
        {x:47.98921003240148,y:12.887350402965037},
        {x:47.349828623710074,y:18.846240364207713},
        {x:45.72768583196203,y:24.615478836192576},
        {x:43.164947413382926,y:30.03287728895136},
        {x:39.738059901175895,y:34.949539505137885},
        {x:35.54631795781652,y:39.23287423719355},
        {x:30.705060862479606,y:42.76549371351191},
        {x:25.344877146659297,y:45.445877395762885},
        {x:19.612545870719355,y:47.193950973643744},
        {x:13.668942355094355,y:47.96235879529902},
        {x:11.999967478690547,y:48.00040467847773},
        {x:7.6796969403604685,y:47.743782364024604},
        {x:1.8093384732584177,y:46.53764947523066},
        {x:-3.7770620356221976,y:44.367969833507026},
        {x:-8.924221135201057,y:41.29822953809687},
        {x:-13.492573834480842,y:37.41907151807734},
        {x:-17.35848889452418,y:32.839540802134955},
        {x:-20.4132445822378,y:27.683479629649607},
        {x:-22.566598779978357,y:22.090760551585642},
        {x:-23.755641974033914,y:16.216908775462596},
      ]
    },
    { color: '#0ACF83', 
      origin: {x:-73.5, y:36},
      vertices: [
        {x:-25.211212599527652,y:13.21071831326526},
        {x:-24.71796973968726,y:7.237903753328737},
        {x:-23.23948284412604,y:1.4301902447227803},
        {x:-20.81167992378455,y:-4.0490105952735576},
        {x:-17.506731713068298,y:-9.048436483335081},
        {x:-13.421169483911804,y:-13.43315728564221},
        {x:-8.668078387033752,y:-17.08356150050122},
        {x:-3.375759566080383,y:-19.89559658427197},
        {x:2.311416184652039,y:-21.785420706462446},
        {x:8.234257256734558,y:-22.700029896539036},
        {x:10.788787400472351,y:-22.78928168673474},
        {x:46.788787400472344,y:-22.78928168673474},
        {x:46.788787400472344,y:13.21071831326526},
        {x:46.626699006307305,y:16.64900700192493},
        {x:45.5661750194909,y:22.547423521089968},
        {x:43.53581575130243,y:28.18595902066272},
        {x:40.59400895808954,y:33.40728584866565},
        {x:36.82810739253778,y:38.06940285306018},
        {x:32.34466699336786,y:42.046373525667605},
        {x:27.26543000911493,y:45.2272874508385},
        {x:21.727782761800476,y:47.51861778836292},
        {x:15.885213410604187,y:48.85270706753772},
        {x:10.788787400472351,y:49.21071831326526},
        {x:9.902067696798035,y:49.1999665890221},
        {x:3.9431834576012577,y:48.56062523465198},
        {x:-1.8260736110327755,y:46.93852821927112},
        {x:-7.243482077371887,y:44.375835577059206},
        {x:-12.160175764810852,y:40.94897667508167},
        {x:-16.443539107096008,y:36.757263341951784},
        {x:-19.97618755127173,y:31.916029134798464},
        {x:-22.656600380194003,y:26.555862585115847},
        {x:-24.404707664501483,y:20.8235541973595},
        {x:-25.173155188438113,y:14.8799449596886},
      ]
    },
    { color: '#FF7262', 
      origin: {x:-6, y:-108},
      vertices: [
        {x:-21.728220878427837,y:-23.9993860494531},
        {x:-21.728220878427845,y:48.0006139505469},
        {x:14.271779121572159,y:48.0006139505469},
        {x:20.24459940355458,y:47.50736215000979},
        {x:26.05230432909169,y:46.02887132054202},
        {x:31.531495155507706,y:43.60105874424807},
        {x:36.53091532152333,y:40.296096586044946},
        {x:40.91564470689931,y:36.210538648422876},
        {x:44.5660467759911,y:31.457446836289087},
        {x:47.378077568227425,y:26.165126584824247},
        {x:49.267914833242074,y:20.477947973068876},
        {x:50.18253237169422,y:14.555124067124051},
        {x:50.27177912157215,y:12.000613950546903},
        {x:50.10969072740711,y:8.562302373703641},
        {x:49.04916674059071,y:2.663885854538602},
        {x:47.01880747240223,y:-2.9746539365685756},
        {x:44.077012123281136,y:-8.195970750991185},
        {x:40.31109911363759,y:-12.858093477431614},
        {x:35.82765871446767,y:-16.83506057376035},
        {x:30.748421730214737,y:-20.015964485350928},
        {x:25.210797371083878,y:-22.307288027945837},
        {x:19.368216575795792,y:-23.641378312949023},
        {x:14.271779121572159,y:-23.9993860494531},
      ]
    },
    { color: '#F24E1E', 
      origin: {x:-72, y:-108},
      vertices: [
        {x:-26.273015791378292,y:12.00013774711508},
        {x:-25.7797702046254,y:17.972952307051603},
        {x:-24.30127906223324,y:23.78066295463461},
        {x:-21.87347202917126,y:29.25985378105063},
        {x:-18.56852489133862,y:34.259273947066255},
        {x:-14.48296194692639,y:38.64400333244223},
        {x:-9.7298701347926,y:42.29441112357993},
        {x:-4.437545591793333,y:45.106441915816255},
        {x:1.2496272979161382,y:46.996273458785005},
        {x:7.172471231021607,y:47.91089099723715},
        {x:9.726984208621705,y:48.00013774711508},
        {x:45.72698420862171,y:48.00013774711508},
        {x:45.72698420862171,y:-23.999862252884917},
        {x:9.726984208621705,y:-23.999862252884917},
        {x:6.288672631778443,y:-23.83777714442592},
        {x:0.39025611261340387,y:-22.777262657099776},
        {x:-5.248293692074094,y:-20.746903835946135},
        {x:-10.469610506496702,y:-17.805101691895537},
        {x:-15.131740385494505,y:-14.039183675461823},
        {x:-19.10870462080029,y:-9.555756150895172},
        {x:-22.28960674425152,y:-4.476513444596344},
        {x:-24.580924743614467,y:1.0611194976033609},
        {x:-25.91501125117329,y:6.903711736983244},
      ]
    },
    { color: '#A259FF', 
      origin: {x:-72, y:-35},
      vertices: [
        {x:-26.273015791378292,y:12.00013774711508},
        {x:-25.7797702046254,y:17.972952307051603},
        {x:-24.30127906223324,y:23.78066295463461},
        {x:-21.87347202917126,y:29.25985378105063},
        {x:-18.56852489133862,y:34.259273947066255},
        {x:-14.48296194692639,y:38.64400333244223},
        {x:-9.7298701347926,y:42.29441112357993},
        {x:-4.437545591793333,y:45.106441915816255},
        {x:1.2496272979161382,y:46.996273458785005},
        {x:7.172471231021607,y:47.91089099723715},
        {x:9.726984208621705,y:48.00013774711508},
        {x:45.72698420862171,y:48.00013774711508},
        {x:45.72698420862171,y:-23.999862252884917},
        {x:9.726984208621705,y:-23.99986225288491},
        {x:6.288672631778443,y:-23.83777714442592},
        {x:0.39025611261340387,y:-22.777262657099776},
        {x:-5.248293692074094,y:-20.746903835946135},
        {x:-10.469610506496702,y:-17.805101691895537},
        {x:-15.131740385494505,y:-14.039183675461823},
        {x:-19.10870462080029,y:-9.555756150895172},
        {x:-22.28960674425152,y:-4.476513444596344},
        {x:-24.580924743614467,y:1.0611194976033609},
        {x:-25.91501125117329,y:6.903711736983244},
      ]
    },
  ],
  3: [
    { color: '#1ABCFE', 
      origin: {x:-3, y:-35},
      vertices: [
        {x:-24.006377458358788,y:12.002093744898751},
        {x:-22.895815074230217,y:3.0943813547620316},
        {x:-19.606830477500942,y:-5.257622696446466},
        {x:-14.349929332519558,y:-12.534045197056818},
        {x:-7.463157415176418,y:-18.292103148984005},
        {x:0.6330869199981422,y:-22.168436802910854},
        {x:9.439232588027927,y:-23.908385947333862},
        {x:11.99332254164121,y:-23.997606255101253},
        {x:18.40344405195615,y:-23.428562022732784},
        {x:26.96897196791074,y:-20.744491197156},
        {x:34.59945178053281,y:-16.016405083226253},
        {x:40.82936358473203,y:-9.553269840764093},
        {x:45.27206301710508,y:-1.753264404820488},
        {x:47.63564562818907,y:6.9062051996716995},
        {x:47.993622541641216,y:12.00239374489875},
        {x:47.786970854019145,y:15.882081054163887},
        {x:45.7213408949127,y:24.617467902613594},
        {x:41.54740023634336,y:32.56445696206183},
        {x:35.539973020767185,y:39.23486330361457},
        {x:28.074717283462498,y:44.219846747828434},
        {x:19.606200933670017,y:47.19594004006476},
        {x:11.993622541641209,y:48.00239374489875},
        {x:10.66346716902158,y:47.978235267115544},
        {x:1.8029935362090797,y:46.53963854165168},
        {x:-6.420995473648098,y:42.94241144509406},
        {x:-13.498918771530178,y:37.421060584498356},
        {x:-18.999736785675076,y:30.327199958277653},
        {x:-22.572943717027687,y:22.09274961800666},
        {x:-23.985846700398856,y:13.228116057825996},
      ]
    },
    { color: '#0ACF83', 
      origin: {x:-73.5, y:36},
      vertices: [
        {x:-25.236974649029484,y:13.231036361847412},
        {x:-24.126414410668126,y:4.323324379120361},
        {x:-20.83744197328638,y:-4.028692546691406},
        {x:-15.580570869045962,y:-11.30513865074109},
        {x:-8.693840436535586,y:-17.06324345191907},
        {x:-0.5976332946593637,y:-20.93965810855817},
        {x:8.208495207232726,y:-22.679711847956888},
        {x:10.76302535097052,y:-22.76896363815259},
        {x:46.763025350970516,y:-22.76896363815259},
        {x:46.763025350970516,y:13.231036361847412},
        {x:46.19405371705938,y:19.64072912612964},
        {x:43.510053701800594,y:28.20627706924487},
        {x:38.782007284564266,y:35.83678549209643},
        {x:32.31890494386602,y:42.06669157424975},
        {x:24.518909521502746,y:46.50941389480639},
        {x:15.859451361102355,y:48.87302511611987},
        {x:10.76302535097052,y:49.23103636184741},
        {x:6.88356692354132,y:49.02440756240893},
        {x:-1.8518356605346078,y:46.95884626785327},
        {x:-9.798853330212344,y:42.784968551788815},
        {x:-16.469301156597844,y:36.77758139053393},
        {x:-21.454322509365788,y:29.312354263458737},
        {x:-24.430469714003316,y:20.84387224594165},
      ]
    },
    { color: '#FF7262', 
      origin: {x:-6, y:-108},
      vertices: [
        {x:-21.68781166468959,y:-23.996489300922093},
        {x:-21.687811664689598,y:48.00351069907791},
        {x:14.312188335310406,y:48.00351069907791},
        {x:23.219897457014508,y:46.89293597678787},
        {x:31.57190436924595,y:43.60395549277908},
        {x:38.848349758039895,y:38.347083315655055},
        {x:44.60645598972935,y:31.460343584820095},
        {x:48.482878871809426,y:23.364140734478298},
        {x:50.22294158543247,y:14.558020815655055},
        {x:50.3121883353104,y:12.003510699077907},
        {x:49.74321670139927,y:5.593800768657985},
        {x:47.05921668614048,y:-2.9717571880375715},
        {x:42.33117599095005,y:-10.602258458331761},
        {x:35.86806792820591,y:-16.832163825229344},
        {x:28.068078227888527,y:-21.274879887298283},
        {x:19.40862578953404,y:-23.638481564418015},
        {x:14.312188335310406,y:-23.996489300922093},
      ]
    },
    { color: '#F24E1E', 
      origin: {x:-72, y:-108},
      vertices: [
        {x:-26.314010554391825,y:12.000995515295639},
        {x:-25.203446024496042,y:20.90870749802269},
        {x:-21.914466792184793,y:29.260711549231182},
        {x:-16.65759676082798,y:36.53715693802513},
        {x:-9.770864897806128,y:42.29526889176048},
        {x:-1.674657755929907,y:46.17168605179466},
        {x:7.131476468008081,y:47.911748765417705},
        {x:9.685989445608179,y:48.000995515295635},
        {x:45.68598944560817,y:48.000995515295635},
        {x:45.68598944560817,y:-23.999004484704365},
        {x:9.685989445608179,y:-23.999004484704365},
        {x:3.276279515188257,y:-23.43003468363606},
        {x:-5.289288455087622,y:-20.746046067765583},
        {x:-12.919798308450659,y:-16.017999292901386},
        {x:-19.14969938381382,y:-9.554898382714617},
        {x:-23.592402750093424,y:-1.7549058213742832},
        {x:-25.956006014186823,y:6.904569505163803},
      ]
    },
    { color: '#A259FF', 
      origin: {x:-72, y:-35},
      vertices: [
        {x:-26.314010554391825,y:12.000995515295639},
        {x:-25.203446024496042,y:20.90870749802269},
        {x:-21.914466792184793,y:29.260711549231182},
        {x:-16.65759676082798,y:36.53715693802513},
        {x:-9.770864897806128,y:42.29526889176048},
        {x:-1.674657755929907,y:46.17168605179466},
        {x:7.131476468008081,y:47.911748765417705},
        {x:9.685989445608179,y:48.000995515295635},
        {x:45.68598944560817,y:48.000995515295635},
        {x:45.68598944560817,y:-23.999004484704365},
        {x:9.685989445608179,y:-23.99900448470435},
        {x:3.276279515188257,y:-23.43003468363606},
        {x:-5.289288455087622,y:-20.746046067765583},
        {x:-12.919798308450659,y:-16.017999292901386},
        {x:-19.14969938381382,y:-9.554898382714617},
        {x:-23.592402750093424,y:-1.7549058213742832},
        {x:-25.956006014186823,y:6.904569505163803},
      ]
    },
  ],
  4: [
    { color: '#1ABCFE', 
      origin: {x:-3, y:-35},
      vertices: [
        {x:-24.01040459606704,y:12.004670296803361},
        {x:-22.038667688108056,y:0.22414182085121226},
        {x:-16.30589152309951,y:-10.254457727488633},
        {x:-7.467184552884666,y:-18.289526597079394},
        {x:3.5123557951683146,y:-22.991271272715686},
        {x:11.989295403932964,y:-23.995029703196643},
        {x:15.428021421694194,y:-23.832905177441},
        {x:26.964944830202494,y:-20.74191464525139},
        {x:36.84836005237046,y:-14.034145132121202},
        {x:44.006227484011085,y:-4.471456304606553},
        {x:47.63161849048081,y:6.90878175157631},
        {x:47.98959540393296,y:12.00497029680336},
        {x:47.33945654895249,y:18.85080598253334},
        {x:43.15457533862534,y:30.03744290727699},
        {x:35.535945883058936,y:39.23743985551918},
        {x:25.334505071901713,y:45.45044301408851},
        {x:13.658570280336772,y:47.966924413624646},
        {x:11.989595403932963,y:48.00497029680336},
        {x:1.7989663985008342,y:46.54221509355629},
        {x:-8.93459320995864,y:41.3027951564225},
        {x:-17.368860969281762,y:32.844106420460584},
        {x:-22.57697085473594,y:22.09532616991127},
      ]
    },
    { color: '#0ACF83', 
      origin: {x:-73.5, y:36},
      vertices: [
        {x:-25.27255595587291,y:13.262227710958303},
        {x:-23.3008262004713,y:1.4816996424158226},
        {x:-17.56807506941356,y:-8.996927085642037},
        {x:-8.729421743379016,y:-17.032052102808173},
        {x:2.2500728283067737,y:-21.7339113087694},
        {x:10.727444044127086,y:-22.737772289041693},
        {x:46.72744404412709,y:-22.737772289041693},
        {x:46.72744404412709,y:13.262227710958303},
        {x:46.56535564996205,y:16.70051639961797},
        {x:43.47447239495717,y:28.237468418355768},
        {x:36.76676403619252,y:38.12091225075323},
        {x:27.204086652769664,y:45.27879684853155},
        {x:15.823870054258922,y:48.90421646523077},
        {x:10.727444044127086,y:49.26222771095831},
        {x:3.8818401012559924,y:48.612134632345025},
        {x:-7.30482543371715,y:44.42734497475225},
        {x:-16.50488246344127,y:36.80877273964483},
        {x:-22.71794373653926,y:26.60737198280889},
        {x:-25.23449854478337,y:14.931454357381643},
      ]
    },
    { color: '#FF7262', 
      origin: {x:-6, y:-108},
      vertices: [
        {x:-21.634073178476285,y:-23.993460087373712},
        {x:-21.634073178476292,y:48.00653991262629},
        {x:14.365926821523711,y:48.00653991262629},
        {x:26.146452029043243,y:46.034797282621405},
        {x:36.62506302147488,y:40.302022548124334},
        {x:44.66019447594265,y:31.463372798368475},
        {x:49.36206253319363,y:20.483873935148257},
        {x:50.36592682152371,y:12.006539912626284},
        {x:50.20383842735867,y:8.568228335783022},
        {x:47.112955172353786,y:-2.9687279744891946},
        {x:40.40524681358914,y:-12.85216751535223},
        {x:30.842569430166286,y:-20.01003852327154},
        {x:19.462364275747344,y:-23.635452350869635},
        {x:14.365926821523711,y:-23.993460087373712},
      ]
    },
    { color: '#F24E1E', 
      origin: {x:-72, y:-108},
      vertices: [
        {x:-26.370717353573703,y:11.998738359723763},
        {x:-24.398980624428653,y:23.779263567243294},
        {x:-18.66622645353403,y:34.25787455967494},
        {x:-9.827571696988011,y:42.29301173618861},
        {x:1.1519257357207273,y:46.99487407139369},
        {x:9.629282646426294,y:47.99873835972377},
        {x:45.6292826464263,y:47.99873835972377},
        {x:45.6292826464263,y:-24.001261640276233},
        {x:9.629282646426294,y:-24.001261640276233},
        {x:6.190971069583032,y:-23.839176531817238},
        {x:-5.345995254269505,y:-20.74830322333745},
        {x:-15.229441947689915,y:-14.04058306285314},
        {x:-22.387308306446933,y:-4.477912831987661},
        {x:-26.0127128133687,y:6.902312349591927},
      ]
    },
    { color: '#A259FF', 
      origin: {x:-72, y:-35},
      vertices: [
        {x:-26.370717353573703,y:11.998738359723763},
        {x:-24.398980624428653,y:23.779263567243294},
        {x:-18.66622645353403,y:34.25787455967494},
        {x:-9.827571696988011,y:42.29301173618861},
        {x:1.1519257357207273,y:46.99487407139369},
        {x:9.629282646426294,y:47.99873835972377},
        {x:45.6292826464263,y:47.99873835972377},
        {x:45.6292826464263,y:-24.001261640276233},
        {x:9.629282646426294,y:-24.001261640276226},
        {x:6.190971069583032,y:-23.839176531817238},
        {x:-5.345995254269505,y:-20.74830322333745},
        {x:-15.229441947689915,y:-14.04058306285314},
        {x:-22.387308306446933,y:-4.477912831987661},
        {x:-26.0127128133687,y:6.902312349591927},
      ]
    },
  ],
  5: [
    { color: '#1ABCFE', 
      origin: {x:-3, y:-35},
      vertices: [
        {x:-24.027119738516987,y:11.994847829188554},
        {x:-20.956306917128742,y:-2.576149339543136},
        {x:-12.237019402442158,y:-14.648979539738448},
        {x:0.6123446398399466,y:-22.175682718621047},
        {x:11.972580261483014,y:-24.004852170811446},
        {x:15.411306279244243,y:-23.842727645055803},
        {x:29.62030495935899,y:-19.389837975369247},
        {x:40.80862130457383,y:-9.560515756474288},
        {x:47.070422070565044,y:3.9496852208511513},
        {x:47.97288026148301,y:11.995147829188554},
        {x:47.322741406502544,y:18.840983514918534},
        {x:41.52665795618516,y:32.55721104635164},
        {x:30.677973645272075,y:42.76023686422273},
        {x:16.629672902169048,y:47.696685915126054},
        {x:11.972880261483013,y:47.995147829188554},
        {x:1.782251256050884,y:46.53239262594148},
        {x:-11.315903765616596,y:39.44812214864656},
        {x:-20.44033179944533,y:27.67822278036043},
        {x:-24.006588980557055,y:13.2208701421158},
      ]
    },
    { color: '#0ACF83', 
      origin: {x:-73.5, y:36},
      vertices: [
        {x:-25.322640478772136,y:13.298857994794744},
        {x:-22.251838028592083,y:-1.2721459190846502},
        {x:-13.53259736315629,y:-13.345017604112726},
        {x:-0.6832991244020157,y:-20.871836475610834},
        {x:10.677359521227867,y:-22.701142005205256},
        {x:46.677359521227864,y:-22.701142005205256},
        {x:46.677359521227864,y:13.298857994794744},
        {x:46.10838788731673,y:19.70855075907697},
        {x:40.48258107884505,y:33.495425530195135},
        {x:29.759879052477864,y:43.830773659467596},
        {x:15.773785531359703,y:48.940846749067205},
        {x:10.677359521227867,y:49.298857994794744},
        {x:0.9130429623899765,y:47.958886452436346},
        {x:-12.271603644055338,y:41.03711635661115},
        {x:-21.53998833910844,y:29.380175896406072},
        {x:-25.284583067682597,y:14.968084641218084},
      ]
    },
    { color: '#FF7262', 
      origin: {x:-6, y:-108},
      vertices: [
        {x:-21.549124801972475,y:-23.998579401055643},
        {x:-21.549124801972482,y:48.00142059894436},
        {x:14.450875198027518,y:48.00142059894436},
        {x:26.23140040554705,y:46.029677968939474},
        {x:38.98703662075701,y:38.344993215521505},
        {x:47.55717364468279,y:26.165933233221697},
        {x:50.45087519802752,y:12.001420598944353},
        {x:50.44816867031756,y:11.558016401251482},
        {x:47.197903548857596,y:-2.9738472881711253},
        {x:38.330912505766776,y:-14.938719648400616},
        {x:25.389893447539237,y:-22.30648137954838},
        {x:14.450875198027518,y:-23.998579401055643},
      ]
    },
    { color: '#F24E1E', 
      origin: {x:-72, y:-108},
      vertices: [
        {x:-26.448213867577316,y:12.002890792351462},
        {x:-23.37740354958415,y:26.57388612316201},
        {x:-14.658160023125413,y:38.64675637767861},
        {x:-1.8088610691154052,y:46.17358132885048},
        {x:9.55178613242268,y:48.00289079235146},
        {x:45.551786132422684,y:48.00289079235146},
        {x:45.551786132422684,y:-23.997109207648542},
        {x:9.55178613242268,y:-23.997109207648542},
        {x:0.21505803641437993,y:-22.7745096118634},
        {x:-13.054001621636155,y:-16.016104015845563},
        {x:-22.464804820450546,y:-4.473760399359966},
        {x:-26.38725465509534,y:9.890860763054587},
      ]
    },
    { color: '#A259FF', 
      origin: {x:-72, y:-35},
      vertices: [
        {x:-26.448213867577316,y:12.002890792351462},
        {x:-23.37740354958415,y:26.57388612316201},
        {x:-14.658160023125413,y:38.64675637767861},
        {x:-1.8088610691154052,y:46.17358132885048},
        {x:9.55178613242268,y:48.00289079235146},
        {x:45.551786132422684,y:48.00289079235146},
        {x:45.551786132422684,y:-23.997109207648542},
        {x:9.55178613242268,y:-23.997109207648528},
        {x:0.21505803641437993,y:-22.7745096118634},
        {x:-13.054001621636155,y:-16.016104015845563},
        {x:-22.464804820450546,y:-4.473760399359966},
        {x:-26.38725465509534,y:9.890860763054587},
      ]
    },
  ],
} // shapeData

const $ = function(target, query) {
  if (query === undefined) {
    query = target
    target = document
  }
  return Array.prototype.slice.call(target.querySelectorAll(query))
}

const Engine = Matter.Engine,
      Render = Matter.Render,
      Runner = Matter.Runner,
      Body = Matter.Body,
      Common = Matter.Common,
      Composite = Matter.Composite,
      Composites = Matter.Composites,
      MouseConstraint = Matter.MouseConstraint,
      Mouse = Matter.Mouse,
      World = Matter.World,
      Vertices = Matter.Vertices,
      Svg = Matter.Svg,
      Bodies = Matter.Bodies,
      Vector = Matter.Vector;

// create engine
const engine = Engine.create({
  enableSleeping: true,
  constraintIterations: 2, // default 2
  positionIterations: 8, // default 6
  velocityIterations: 5, // default 4
  world: World.create({
    gravity: {
      scale: 0.001, // default 0.001
      x: 0, // default 0
      y: 0, // default 1
    }
  }),
})

// world
const world = engine.world

// create renderer
var render = Render.create({
  element: document.querySelector('#canvasContainer'),
  engine: engine,
  options: {
    width:      viewportSize.width,
    height:     viewportSize.height,
    wireframes: wireframeMode,
    background: '#000',
    wireframeBackground: '#000',
    showSleeping: false, // default true
    showDebug: debugMode, // default false
    showBroadphase: false, // default false
    showBounds: false, // default false
    showVelocity: debugMode, // default false
    showCollisions: debugMode, // default false
    showSeparations: debugMode, // default false
    showAxes: false, // default false
    showPositions: false, // default false
    showAngleIndicator: debugMode, // default false
    showIds: false, // default false
    showShadows: false, // default false
    showVertexNumbers: false, // default false
    showConvexHulls: false, // default false
    showInternalEdges: false, // default false
    showMousePosition: false, // default false
  }
});

Render.run(render)

const runner = Runner.create()
Runner.run(runner, engine)

const fMeshFillerShape = { color: '#ff0', 
  origin: {x:0, y:0},
  hidden: true,
  vertices: [
    {x:1,y:0},
    {x:0,y:1},
    {x:2,y:1},
  ]
}

function mdecomp(a) {
  let angle = Math.atan2(a[1], a[0]),
      denom = Math.pow(a[0], 2) + Math.pow(a[1], 2),
      scaleX = Math.sqrt(denom),
      scaleY = (a[0] * a[3] - a[2] * a[1]) / scaleX
  // let skewX = Math.atan2(a[0] * a[2] + a[1] * a[3], denom)
  return {
    angle:  angle, // / (Math.PI / 180),  // this is rotation angle in degrees
    scaleX: scaleX,                  // scaleX factor  
    scaleY: scaleY,                  // scaleY factor
    // skewX:  skewX, // / (Math.PI / 180),  // skewX angle degrees
    // skewY:  0,                        // skewY angle degrees
  };
}

function copyVertices(vertices) {
  return vertices.map(v => ({x:v.x, y:v.y}))
}


function shapesFromSVGPaths(svg, scale, detailGranularity) {
  let shapes = []

  for (let path of $(svg, 'path')) {
    let color = path.getAttribute('fill')
    let transform = path.getAttribute('transform')
    let vertices = Svg.pathToVertices(path, detailGranularity)
    let origin = {x: 0, y: 0}

    if (transform) {
      let m
      if (m = transform.match(/translate\(\s*([\-+\.\d]+)\s+([\-+\.\d]+)\s*\)/)) {
        origin.x = parseFloat(m[1]) * scale
        origin.y = parseFloat(m[2]) * scale
      }
      else if (m = transform.match(/matrix\(([^\)]+)\)/)) {
        // matrix(
        //   a, b,
        //   c, d,
        //   tx, ty
        // )
        console.warn('matrix transforms not fully supported')
        m = m[1].split(/[,\s]+/g).map(parseFloat)
        // console.log(color + ' matrix',
        //   m.slice(0,2).join(', ') + '\n' +
        //   m.slice(2,4).join(', ') + '\n' +
        //   m.slice(4).join(', '))

        let c = mdecomp(m)
        if (c.scaleX != 1 || c.scaleY != 1) {
          vertices = Vertices.scale(vertices, c.scaleX, c.scaleY, {x:0, y:0})
          // TODO: compensate origin as needed
        }
        if (c.angle != 0) {
          let point = {x:0, y:0} // Vertices.centre(vertices)
          vertices = Matter.Vertices.rotate(vertices, c.angle, point)
        }

        origin.x = m[4] * scale
        origin.y = m[5] * scale
      }
    }

    switch (color) {
      // case '#F24E1E': { // top-left; red half-pill
      //   break
      // }
      case '#FF7262': { // top-right; light-red half-pill
        origin.x -= 6
        break
      }
      case '#A259FF': { // center-left; purple half-pill
        origin.y += 1
        break
      }
      case '#1ABCFE': { // center-right; blue circle
        origin.x -= 3
        origin.y += 1
        break
      }
      case '#0ACF83': { // bottom-left; green droplet
        origin.x -= 1.5
        break
      }
    }

    if (scale != 1) {
      vertices = Vertices.scale(vertices, scale, scale)
    }

    shapes.push({
      color: color,
      origin: origin,
      vertices: vertices,
    })
  }
  return shapes
}

function shapeDataToJS(shapeData) {
  let s = []
  for (let detailGranularity of Object.keys(shapeData)) {
    s.push('  ' + detailGranularity + ': [\n')
    let shapes = shapeData[detailGranularity]
    for (let shape of shapes) {
      s.push(
        "    { color: '" + shape.color + "', \n" +
        "      origin: {x:" + shape.origin.x + ", y:" + shape.origin.y + "},\n" +
        "      vertices: [\n"
      )
      for (let v of shape.vertices) {
        s.push('        {x:' + v.x + ',y:' + v.y + '},\n')
      }
      s.push(
        '      ]\n'+
        '    },\n'
      )
    }
    s.push('  ],\n')
  }
  return '{\n' + s.join('') + '}'
}

// Uncomment this to import shapes from SVG. Requires pathseg.js
// shapeData = {}
// let svg = $('svg')[0]
// for (let detailGranularity of [1, 2, 3, 4, 5]) {
//   shapeData[detailGranularity] = shapesFromSVGPaths(svg, 3, detailGranularity)
// }
// console.log(shapeDataToJS(shapeData))


// Pick the highest-resolution shapes, but not higher than needed.
const pixelScale = (window.devicePixelRatio || 1) / (
  render.context.backingStorePixelRatio ||
  render.context.webkitBackingStorePixelRatio ||
  render.context.mozBackingStorePixelRatio ||
  render.context.msBackingStorePixelRatio ||
  render.context.oBackingStorePixelRatio ||
  1)
const detailGranularity = (
  /iphone|ipad|ipod|android|blackberry|opera mini|iemobile/i.test(navigator.userAgent) ? (
    pixelScale <= 1 ? 5 :
    pixelScale <= 3 ? 3 :
    pixelScale <= 4 ? 2 :
                      1
  ) :
  pixelScale <= 1 ? 2 :
                    1
)
// console.log('shape detailGranularity', detailGranularity)
// document.querySelector('#ui').innerText = detailGranularity
const shapes = shapeData[detailGranularity]

// createFPart(shape, x, y, [options])
// Options:
//   ignoreOrigin :bool
//   scale :number
//   color :string
//   [any other property passed on to Bodies.fromVertices]
function createFPart(shape, x, y, options) {
  options = options || {}
  let scale = options.scale || 1
  let _x = options.ignoreOrigin ? x : x + (shape.origin.x / scale)
  let _y = options.ignoreOrigin ? y : y + (shape.origin.y / scale)
  let vertices = shape.vertices
  if (scale != 1) {
    vertices = copyVertices(shape.vertices)
    vertices = Vertices.scale(vertices, scale, scale)
  }

  options = Object.assign(shape.hidden ? {
      collisionFilter: {
        mask: 0, // don't collide with anything, including the mouse
      },
      render: {
        visible: false
      }
    } : {
    friction:       0.2, // default 0.1
    frictionAir:    0.001, // default 0.01
    frictionStatic: 0.5, // default 0.5
    density:        0.1, // default 0.001
    restitution:    0.2, // default 0
    // inertia: Infinity,
    render: {
      fillStyle: options.color || shape.color,
      strokeStyle: options.color || shape.color,
      lineWidth: 1,
    }
  }, options)

  // [flagInternal=false], [removeCollinear=0.01], [minimumArea=10]
  const flagInternal    = false // flag internal edges (coincident part edges)
  const removeCollinear = false // default 0.01; `false` to disable
  const minimumArea     = 1     // default 10
  return Bodies.fromVertices(
    _x, _y, vertices, options, flagInternal, removeCollinear, minimumArea)
}

function createFMesh(x, y) { // :Composite
  let partOptions = {
    friction: 0.1,
    frictionStatic: 2.5,
    restitution: 0.1,
    density: 1,
  }
  let bodies = shapes.map(shape => createFPart(shape, x, y, partOptions))
  bodies.push(createFPart(fMeshFillerShape, x, y, {friction:0}))
  let composite = Composite.create({
    bodies: bodies,
  })
  let columns = 2
  let rows = 3
  let crossBrace = true
  let constraintOptions = {
    stiffness: 0.1,
    render: {
      visible: debugMode
    }
  }
  return Composites.mesh(composite, columns, rows, crossBrace, constraintOptions)
}

let shapesOffset = {
  x: (viewportSize.width / 2) + 40,
  y: (viewportSize.height / 2) + 10,
}
World.add(world, [
  createFMesh(shapesOffset.x, shapesOffset.y),
])

setTimeout(() => {
  world.gravity.y = 2
}, 1000)

let visibleShapes = shapes.filter(shape => !shape.hidden)
let colors = visibleShapes.map(shape => shape.color).concat([
  '#FFFFFF', '#FFDB29', '#5375FF', '#FF77C3', '#37ECD2',
])

const maxRandomParts = 30

function spawnRandomPart(nth) {
  if (nth < maxRandomParts) {
    setTimeout(spawnRandomPart.bind(null, nth + 1), 500 + (Math.random() * 2000))
  }

  let shape = Common.choose(visibleShapes)
  let x = Math.random() * (viewportSize.width - 50)
  let y = -100 // Math.random() * (viewportSize.height - 50)
  let color = Common.choose(colors)
  const minScale = 0.1
  const maxScale = 2
  let scale = 0.1 + (Math.random() * (maxScale - minScale))
  let relScale = scale / maxScale
  let randomPart = createFPart(shape, x, y, {
    ignoreOrigin: true,
    scale: scale,
    color: color,
    frictionAir: 0.00001,
    friction: 0.7,
    frictionStatic: 0.7,
    restitution: 0.4 + ((Math.random() * 0.45) * relScale) + (Math.random() * 0.1), // <1
    density: relScale,
    // force: {
    //   x: Math.random() * relScale,
    //   y: Math.random() * relScale
    // },
  })
  // let a = randomPart.bounds.min, b = randomPart.bounds.max
  // randomPart.position.y = b.y - a.y
  return World.add(world, randomPart)
}

setTimeout(spawnRandomPart.bind(null, 0), 2000)

// walls
const wallopt = {
  friction: 0.5,
  frictionStatic:0.5,
  isStatic: true,
  render: {
    fillStyle: '#222',
    // visible: debugMode
  }
}
const wallThickness = 400
const wallOffs = wallThickness/2
const ceilAdj = 200
const vw = viewportSize.width, vh = viewportSize.height
World.add(world, [
  // x, y, width, height
  /*T*/Bodies.rectangle(vw/2,          -ceilAdj + -wallOffs, vw,             wallThickness, wallopt),
  /*B*/Bodies.rectangle(vw/2,          vh + wallOffs,        vw,             wallThickness, wallopt),
  /*R*/Bodies.rectangle(vw + wallOffs, ((vh -ceilAdj)/2),     wallThickness,  ceilAdj + vh,            wallopt),
  /*L*/Bodies.rectangle(-wallOffs,     ((vh -ceilAdj)/2),     wallThickness,  ceilAdj + vh,            wallopt)
])

// add mouse control
let mouse = Mouse.create(render.canvas)
let mouseConstraint = MouseConstraint.create(engine, {
    mouse: mouse,
    constraint: {
      stiffness: 0.4,
      render: {
        visible: debugMode
      }
    }
  }
)

World.add(world, mouseConstraint);

// keep the mouse in sync with rendering
render.mouse = mouse;

// fit the render viewport to the scene
Render.lookAt(render, {
  min: { x: 0, y: 0 },
  max: { x: viewportSize.width, y: viewportSize.height }
})

Render.setPixelRatio(render, 'auto')
window.addEventListener('resize', ev => {
  // console.log('resize win. render.options.pixelRatio=', render.options.pixelRatio)
  render.options.width = document.documentElement.clientWidth
  render.options.height = document.documentElement.clientHeight
  Render.setPixelRatio(render, render.options.pixelRatio)
  Render.lookAt(render, {
    min: { x: 0, y: 0 },
    max: { x: viewportSize.width, y: viewportSize.height }
  })
}, {passive:true, capture:false})

// make it easy to mess around with stuff via the console
window['toy'] = {
  render: render,
  spawnRandomPart: function() {
    return spawnRandomPart(maxRandomParts)
  },
  spawnFMesh: function() {
    return World.add(world, createFMesh(150, 100))
  },
}

// 

// initAutohidingUI(ui :Element, options :{}, onChangeVisibility? :func)
// initAutohidingUI(ui :Element, onChangeVisibility? :func)
//   onChangeVisibility(visible :bool)
//   options:
//     timeout :number = 2000
//     initialDelay :number = 2000   // in addition to timeout first time
//     initiallyHidden :boolean = classList.contains('hidden')
//     initiallyFrozen :boolean = false  // when true, does not hide until pointermove
//
// function initAutohidingUI(ui, options, onChangeVisibility) {
//   if (typeof options == 'function') {
//     onChangeVisibility = options
//     options = {}
//   } else if (!options || typeof options != 'object') {
//     options = {}
//   }
//   if (options.initiallyHidden === undefined) {
//     options.initiallyHidden = ui.classList.contains('hidden')
//   }
//   let obj = {
//     hidden: !!options.initiallyHidden,
//   }
//   let timeout = Math.max(options.timeout || 0, 0) || 2000
//   let initialDelay = Math.max(options.initialDelay || 0, 0) || 2000
//   let lastReset = 0
//   let initialDelayAdded = !!options.initiallyHidden || !!options.initiallyFrozen
//   let resetTimeoutThreshold = 200 // some reasonable duration sample of pointermove events
//   let pointerInsideUI = false
//   let timer = null

//   function hideUI() {
//     clearTimeout(timer)
//     if (!obj.hidden) {
//       ui.classList.add('hidden')
//       obj.hidden = true
//       if (onChangeVisibility) {
//         onChangeVisibility.call(obj, false)
//       }
//     }
//   }

//   function showUI() {
//     if (obj.hidden) {
//       ui.classList.remove('hidden')
//       obj.hidden = false
//       if (onChangeVisibility) {
//         onChangeVisibility.call(obj, true)
//       }
//     }
//   }

//   function restartTimeout(timeStamp) {
//     lastReset = timeStamp || 0
//     clearTimeout(timer)
//     if (initialDelayAdded) {
//       timer = setTimeout(hideUI, timeout)
//     } else {
//       timer = setTimeout(hideUI, timeout + initialDelay)
//       initialDelayAdded = true
//     }
//     showUI()
//   }

//   function onPointerMove(ev) {
//     if (!pointerInsideUI &&
//         (lastReset == 0 || ev.timeStamp - lastReset > resetTimeoutThreshold))
//     {
//       restartTimeout(ev.timeStamp)
//     }
//   }

//   function onPointerOverUI() {
//     pointerInsideUI = true
//     clearTimeout(timer)
//     showUI()
//   }

//   function onPointerLeftUI(ev) {
//     pointerInsideUI = false
//     restartTimeout(ev.timeStamp)
//   }

//   const pevopts = {passive:true, capture:false}
//   if (window.PointerEvent) {
//     ui.addEventListener('pointerover', onPointerOverUI, pevopts)
//     ui.addEventListener('pointerleave', onPointerLeftUI, pevopts)
//     document.addEventListener('pointermove', onPointerMove, pevopts)
//   } else {
//     ui.addEventListener('mouseover', onPointerOverUI, false)
//     ui.addEventListener('mouseleave', onPointerLeftUI, false)
//     document.addEventListener('mousemove', onPointerMove, false)
//   }

//   if (!options.initiallyHidden && !options.initiallyFrozen) {
//     restartTimeout(0)
//   }

//   obj.element = ui
//   obj.show = function() {
//     restartTimeout(0)
//     showUI()
//   }
//   obj.hide = hideUI
//   obj.detach = function() {
//     clearTimeout(timer)
//     showUI()
//     this.show = function() {}
//     this.hide = function() {}
//     if (window.PointerEvent) {
//       ui.removeEventListener('pointerover', onPointerOverUI, pevopts)
//       ui.removeEventListener('pointerleave', onPointerLeftUI, pevopts)
//       document.removeEventListener('pointermove', onPointerMove, pevopts)
//     } else {
//       ui.removeEventListener('mouseover', onPointerOverUI, false)
//       ui.removeEventListener('mouseleave', onPointerLeftUI, false)
//       document.removeEventListener('mousemove', onPointerMove, false)
//     }
//   }
//   return obj
// }

// // 

// const ui = document.querySelector('#ui')
// initAutohidingUI(ui, {initiallyFrozen:true}, visible => {
//   console.log('ui visible', visible)
// })

})();
